import pytest
import sys
import os

# Define the path to the temporary file where the generated code will be stored.
# This path is relative to the current working directory during pytest execution,
# which is the experiment-specific output directory (e.g., 02_RawData/roundtrip_...).
GENERATED_CODE_PATH = "temp_generated_code.py"

@pytest.fixture
def script_executor():
    """
    A pytest fixture that provides a callable to execute the LLM-generated code.

    This fixture reads the Python code generated by the LLM from a temporary
    file (temp_generated_code.py), executes it using `exec`, and extracts
    the 'execute' function defined within that code.

    Returns:
        A callable function, which when called, returns the 'execute' function
        from the generated code.
    """
    def _executor():
        # Ensure the path is absolute for exec, or relative to the cwd of pytest.
        # pytest is run with cwd set to the output_dir, so GENERATED_CODE_PATH
        # needs to be relative to that directory.
        full_generated_code_path = os.path.join(os.getcwd(), GENERATED_CODE_PATH)

        if not os.path.exists(full_generated_code_path):
            pytest.fail(f"Generated code file not found at {full_generated_code_path}")

        with open(full_generated_code_path, 'r', encoding='utf-8') as f:
            code_to_execute = f.read()

        # Prepare the execution environment
        exec_globals = {}
        # Provide numpy and scipy to the execution context for the generated code
        try:
            import numpy as np
            exec_globals['np'] = np
        except ImportError:
            pytest.fail("Numpy not found. Please install with 'pip install numpy'")
        try:
            from scipy.optimize import minimize
            exec_globals['minimize'] = minimize
        except ImportError:
            pytest.fail("Scipy not found. Please install with 'pip install scipy'")
        
        try:
            # Execute the code in a dictionary to capture local variables
            # This should define the 'execute' function in exec_globals
            print("--- Code to be executed ---")
            print(code_to_execute)
            print("---------------------------")
            exec(code_to_execute, exec_globals)
        except Exception as e:
            pytest.fail(f"Error executing generated code: {e}")

        # The generated code is expected to define an 'execute' function
        if "execute" not in exec_globals or not callable(exec_globals["execute"]):
            pytest.fail("Generated code did not define a callable 'execute' function.")
            
        return exec_globals["execute"]

    return _executor
